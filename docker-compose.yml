version: '3.8'

services:
  # MySQL 데이터베이스
  mysql:
    image: mysql:8.0
    container_name: groupware-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: groupware
      MYSQL_USER: groupware
      MYSQL_PASSWORD: groupware123
    ports:
      - '3307:3306'
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - groupware-network
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'groupware', '-pgroupware123']
      timeout: 20s
      retries: 10

  # Node.js 서버
  server:
    image: groupware-server:latest
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: groupware-server
    restart: unless-stopped
    ports:
      - '3001:3001'
    environment:
      NODE_ENV: production
      DATABASE_URL: 'mysql://groupware:groupware123@mysql:3306/groupware'
      SHADOW_DATABASE_URL: 'mysql://groupware:groupware123@mysql:3306/groupware_shadow'
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - groupware-network
    command: >
      sh -c "
        echo 'Waiting for MySQL to be ready...' &&
        sleep 10 &&
        npx prisma db push &&
        node dist/index.js
      "

  # React 프론트엔드
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: groupware-client
    restart: unless-stopped
    ports:
      - '3000:80'
    depends_on:
      - server
    networks:
      - groupware-network

volumes:
  mysql_data:

networks:
  groupware-network:
    driver: bridge
